#!/bin/bash
echo "Foreman API call to build a new Tomcat instance on OpenStack"
curl -X POST -H "Accept: application/json" -H "Content-Type: application/json" -s -k -u admin:July2016 https://10.20.0.169/api/v2/hosts -d '{"host":{"name":"tomcatsrv03", "hostgroup_id":"4", "compute_resource_id":"2", "openscap_proxy_id":"", "puppetclass_ids":["", "123"], "managed":"true", "type":"Host::Managed", "interfaces_attributes":{"0":{"_destroy":"0", "type":"Nic::Managed", "mac":"", "identifier":"", "name":"tomcatsrv03", "domain_id":"3", "subnet_id":"", "ip":"", "ip6":"", "managed":"1", "primary":"1", "provision":"1", "execution":"1", "virtual":"0", "tag":"", "attached_to":""}}, "compute_attributes":{"flavor_ref":"52a77728-8ad2-4226-9462-c36e3114e61e", "availability_zone":"", "tenant_id":"d7380cddb6fd4a218f2381a9a6b3d63a", "security_groups":"default", "nics":["", "51dec0e4-157e-478a-94cf-714faaea5901"], "network":"ext-net", "boot_from_volume":"false", "size_gb":"", "scheduler_hint_filter":"", "image_ref":"e1d8e1b3-35d5-4b1c-b586-246836228247"}, "architecture_id":"3", "operatingsystem_id":"5", "provision_method":"image", "build":"1", "medium_id":"1", "ptable_id":"80", "pxe_loader":"None", "disk":"", "is_owned_by":"3-Users", "enabled":"1", "model_id":"", "expired_on":"", "comment":"", "overwrite":"false"}, "capabilities":"image", "provider":"Openstack", "bare_metal_capabilities":"build"}'
echo "Getting the IP address for newly build VM"
IP=`curl -X GET -H "Accept: application/json" -H "Content-type: application/json" -s -k -u admin:July2016 https://10.20.0.169/api/v2/hosts/tomcatsrv03.openstacklocal | awk -F"[,:}]" '{print $2}' | tr -d '"'`
echo "Waiting for Tomcat Server to start on $IP"
while ! nc -q 1 $IP 8080 </dev/null; do sleep 10; done
echo "Tomcat is UP on $IP"
